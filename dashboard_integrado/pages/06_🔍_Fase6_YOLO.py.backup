"""
P√°gina Fase 6 - Vision Computacional com YOLO
FarmTech Solutions - Dashboard Integrado
"""

import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import sys
from pathlib import Path
import cv2
import numpy as np
from PIL import Image

# Adicionar diret√≥rio pai ao path
sys.path.append(str(Path(__file__).parent.parent))

from servicos.fase6_yolo import (
    DetectorYOLO,
    GeradorImagensTeste,
    RelatorioVisao,
    gerar_dados_exemplo_yolo
)

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Fase 6 - Vision Computacional YOLO",
    page_icon="üîç",
    layout="wide"
)

# Importar e aplicar CSS global
from styles import apply_global_css
apply_global_css()

# CSS customizado
st.markdown("""
<style>
    /* Fundo branco para toda a p√°gina */
    .main {
        background-color: #999 !important;
    }
    .stApp {
        background-color: #999 !important;
    }
    [data-testid="stAppViewContainer"] {
        # background-color: #ffffff !important;
    }
    .detection-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
    }
    .health-good {
        background-color: #E8F5E9;
        padding: 15px;
        border-radius: 10px;
        border-left: 5px solid #4CAF50;
        margin: 10px 0;
    }
    .health-warning {
        background-color: #FFF3E0;
        padding: 15px;
        border-radius: 10px;
        border-left: 5px solid #FF9800;
        margin: 10px 0;
    }
    .health-critical {
        background-color: #FFEBEE;
        padding: 15px;
        border-radius: 10px;
        border-left: 5px solid #F44336;
        margin: 10px 0;
    }
    .detection-item {
        background-color: #E3F2FD;
        padding: 10px;
        border-radius: 5px;
        margin: 5px 0;
    }
</style>
""", unsafe_allow_html=True)

# Header
st.title("üîç Fase 6 - Vision Computacional com YOLO")
st.markdown("### Sistema de Detec√ß√£o de Gatos üê± e Cachorros üê∂ com Deep Learning")

st.markdown("---")

# Descri√ß√£o
with st.expander("‚ÑπÔ∏è Sobre Vision Computacional com YOLO"):
    st.markdown("""
    **YOLO (You Only Look Once)** √© um modelo de detec√ß√£o de objetos em tempo real.

    **Modelo Atual:**
    - üéØ YOLOv8 Nano treinado por 100 √©pocas (labels corrigidas)
    - üìä mAP50: 35.6% | Precision: 75.0% | Recall: 66.3%
    - üî¨ Dataset: 82 imagens (cat/dog)
    - üìç Localizado em: `/fases/fase_6_cap_1/`

    **Classes Detectadas:**
    - üê± Gato (Cat)
    - üê∂ Cachorro (Dog)

    **Como Usar:**
    1. üì∏ Fa√ßa upload de uma **foto de gato ou cachorro** (JPG, PNG)
    2. üé≤ Ou gere uma imagem de teste
    3. üéöÔ∏è Ajuste a confian√ßa m√≠nima (recomendado: 0.5)
    4. üîç Clique em "Analisar Imagem"

    **Caracter√≠sticas:**
    - ‚úÖ Detec√ß√£o em tempo real com YOLOv8
    - ‚úÖ Modelo customizado treinado (100 √©pocas (labels corrigidas))
    - ‚úÖ Visualiza√ß√£o de bounding boxes
    - ‚úÖ An√°lise de confian√ßa das predi√ß√µes
    - ‚úÖ Estat√≠sticas detalhadas de detec√ß√µes

    **Nota:** Este √© um modelo de demonstra√ß√£o treinado com dataset de pets.
    A mesma tecnologia pode ser aplicada para detec√ß√£o de pragas, doen√ßas e
    outros objetos agr√≠colas.
    """)

st.markdown("---")

# Inicializar session state
if 'dados_yolo' not in st.session_state:
    st.session_state.dados_yolo = gerar_dados_exemplo_yolo()
    st.session_state.imagens_analisadas = []

# Tabs
tab1, tab2, tab3, tab4 = st.tabs(["üì∑ An√°lise de Imagem", "üìä Hist√≥rico", "üéØ Detec√ß√µes", "üìà Estat√≠sticas"])

# TAB 1: AN√ÅLISE DE IMAGEM
with tab1:
    st.markdown("## üì∑ An√°lise de Imagem com YOLO")

    col1, col2 = st.columns([2, 1])

    with col1:
        st.markdown("### Envio de Imagem")

        # Op√ß√µes de entrada
        opcao_entrada = st.radio(
            "Como deseja enviar a imagem?",
            ["Gerar Imagem de Teste", "Fazer Upload"],
            horizontal=True
        )

        imagem_para_analisar = None

        if opcao_entrada == "Gerar Imagem de Teste":
            if st.button("üé≤ Gerar Imagem de Teste", use_container_width=True):
                imagem_numpy = GeradorImagensTeste.gerar_imagem_aleatoria()
                imagem_para_analisar = imagem_numpy

                # Exibir imagem
                st.image(imagem_numpy, caption="Imagem de Teste Gerada", use_container_width=True)

                # Armazenar para an√°lise
                st.session_state.imagem_temp = imagem_numpy

        else:
            arquivo_upload = st.file_uploader(
                "Selecione uma imagem",
                type=["jpg", "jpeg", "png"],
                help="Fa√ßa upload de uma foto da sua planta√ß√£o"
            )

            if arquivo_upload:
                imagem_pil = Image.open(arquivo_upload)
                imagem_numpy = cv2.cvtColor(np.array(imagem_pil), cv2.COLOR_RGB2BGR)
                st.image(imagem_pil, caption="Imagem Enviada", use_container_width=True)
                st.session_state.imagem_temp = imagem_numpy
                imagem_para_analisar = imagem_numpy

    with col2:
        st.markdown("### Par√¢metros de Detec√ß√£o")

        confianca_minima = st.slider(
            "Confian√ßa M√≠nima:",
            min_value=0.3,
            max_value=0.95,
            value=0.5,
            step=0.05,
            help="Objetos com confian√ßa menor ser√£o ignorados"
        )

        st.markdown("---")

        st.markdown("### ‚ú® Modelos Dispon√≠veis")
        st.write("- YOLOv8 Nano")
        st.write("- YOLOv8 Small")
        st.write("- YOLOv8 Medium")

    st.markdown("---")

    # Bot√£o para analisar
    if st.button("üîç Analisar Imagem", type="primary", use_container_width=True):
        if 'imagem_temp' in st.session_state:
            detector = st.session_state.dados_yolo["detector"]
            imagem = st.session_state.imagem_temp

            # Detectar objetos
            resultado = detector.detectar_objetos(imagem, confianca_minima)

            # Analisar sa√∫de
            saude = detector.analisar_saude_plantacao(resultado['deteccoes'])

            # Armazenar an√°lise
            st.session_state.imagens_analisadas.append({
                "timestamp": resultado['timestamp'],
                "total_objetos": resultado['total_objetos'],
                "confianca_media": resultado['confianca_media'],
                "saude": saude
            })

            # Exibir resultados
            st.markdown("### üìä Resultados da Detec√ß√£o")

            # Mostrar modo de detec√ß√£o
            modo = resultado.get('modo', 'Desconhecido')
            if modo == "YOLO Real":
                st.success(f"‚úÖ **Modo:** {modo} - Usando modelo treinado (100 √©pocas (labels corrigidas))")
            else:
                st.warning(f"‚ö†Ô∏è **Modo:** {modo} - Modelo n√£o carregado, usando simula√ß√£o")

            col1, col2, col3, col4 = st.columns(4)

            with col1:
                st.metric(
                    "Objetos Detectados",
                    resultado['total_objetos']
                )

            with col2:
                st.metric(
                    "Confian√ßa M√©dia",
                    f"{resultado['confianca_media']:.1%}"
                )

            with col3:
                st.metric(
                    "Score de Confian√ßa",
                    f"{saude['score_saude']:.1f}/100"
                )

            with col4:
                cor_status = "üü¢" if saude['score_saude'] >= 80 else "üü°" if saude['score_saude'] >= 50 else "üî¥"
                st.metric(
                    "Status",
                    cor_status,
                    saude['status']
                )

            st.markdown("---")

            # Detec√ß√µes detalhadas
            if resultado['deteccoes']:
                st.markdown("### üéØ Detec√ß√µes Encontradas")

                for i, det in enumerate(resultado['deteccoes'], 1):
                    col1, col2, col3 = st.columns([2, 1, 1])

                    with col1:
                        st.write(f"**{i}. {det['classe']}**")

                    with col2:
                        st.write(f"Confian√ßa: {det['confianca']:.1%}")

                    with col3:
                        st.write(f"√Årea: {det['bbox']['width']}√ó{det['bbox']['height']}")

            st.markdown("---")

            # Recomenda√ß√µes
            st.markdown("### üí° Recomenda√ß√µes")
            for rec in saude['recomendacoes']:
                st.write(rec)
        else:
            st.error("‚ùå Por favor, primeiro gere ou envie uma imagem")

# TAB 2: HIST√ìRICO
with tab2:
    st.markdown("## üìä Hist√≥rico de An√°lises")

    detector = st.session_state.dados_yolo["detector"]
    historico = detector.obter_historico()

    if historico:
        col1, col2, col3 = st.columns(3)

        with col1:
            st.metric(
                "Total de An√°lises",
                len(historico)
            )

        with col2:
            media_objetos = np.mean([h['total_objetos'] for h in historico])
            st.metric(
                "M√©dia de Objetos",
                f"{media_objetos:.1f}"
            )

        with col3:
            media_confianca = np.mean([h['confianca_media'] for h in historico])
            st.metric(
                "Confian√ßa M√©dia",
                f"{media_confianca:.1%}"
            )

        st.markdown("---")

        # Tabela de hist√≥rico
        df_historico = pd.DataFrame([
            {
                "Timestamp": h['timestamp'],
                "Objetos": h['total_objetos'],
                "Confian√ßa": f"{h['confianca_media']:.1%}"
            }
            for h in historico
        ])

        st.dataframe(df_historico, use_container_width=True, hide_index=True)

        st.markdown("---")

        # Gr√°ficos
        col1, col2 = st.columns(2)

        with col1:
            fig_objetos = go.Figure()
            fig_objetos.add_trace(go.Scatter(
                y=[h['total_objetos'] for h in historico],
                mode='lines+markers',
                name='Objetos Detectados',
                line=dict(color='#2196F3'),
                fill='tozeroy'
            ))
            fig_objetos.update_layout(
                title="Objetos Detectados por An√°lise",
                xaxis_title="An√°lise",
                yaxis_title="Quantidade",
                hovermode='x unified'
            )
            st.plotly_chart(fig_objetos, use_container_width=True)

        with col2:
            fig_confianca = go.Figure()
            fig_confianca.add_trace(go.Scatter(
                y=[h['confianca_media'] for h in historico],
                mode='lines+markers',
                name='Confian√ßa M√©dia',
                line=dict(color='#4CAF50'),
                fill='tozeroy'
            ))
            fig_confianca.update_layout(
                title="Confian√ßa M√©dia das Detec√ß√µes",
                xaxis_title="An√°lise",
                yaxis_title="Confian√ßa (%)",
                yaxis=dict(range=[0, 1]),
                hovermode='x unified'
            )
            st.plotly_chart(fig_confianca, use_container_width=True)
    else:
        st.info("üì≠ Nenhuma an√°lise realizada ainda. Use a aba 'An√°lise de Imagem' para come√ßar.")

# TAB 3: DETEC√á√ïES
with tab3:
    st.markdown("## üéØ Resumo de Detec√ß√µes")

    detector = st.session_state.dados_yolo["detector"]
    historico = detector.obter_historico()

    if historico:
        # Contar todas as detec√ß√µes
        todas_deteccoes = []
        for h in historico:
            todas_deteccoes.extend(h['deteccoes'])

        saude_geral = detector.analisar_saude_plantacao(todas_deteccoes)

        # Exibir score de confian√ßa
        col1, col2 = st.columns([2, 1])

        with col1:
            if saude_geral['score_saude'] >= 80:
                st.markdown(f"""
                <div class="health-good">
                    <h3>‚úÖ {saude_geral['status']}</h3>
                    <h2>{saude_geral['score_saude']:.1f}/100</h2>
                    <p>Detec√ß√µes com excelente confian√ßa!</p>
                </div>
                """, unsafe_allow_html=True)
            elif saude_geral['score_saude'] >= 50:
                st.markdown(f"""
                <div class="health-warning">
                    <h3>‚ö†Ô∏è {saude_geral['status']}</h3>
                    <h2>{saude_geral['score_saude']:.1f}/100</h2>
                    <p>Confian√ßa moderada nas detec√ß√µes.</p>
                </div>
                """, unsafe_allow_html=True)
            else:
                st.markdown(f"""
                <div class="health-critical">
                    <h3>üö® {saude_geral['status']}</h3>
                    <h2>{saude_geral['score_saude']:.1f}/100</h2>
                    <p>Baixa confian√ßa - tente outras imagens!</p>
                </div>
                """, unsafe_allow_html=True)

        with col2:
            st.markdown("### üìã Total de Detec√ß√µes")
            st.write(f"üê± Gatos: {saude_geral.get('gatos_detectados', 0)}")
            st.write(f"üê∂ Cachorros: {saude_geral.get('cachorros_detectados', 0)}")
            st.write(f"üìä Total: {saude_geral['total_deteccoes']}")

        st.markdown("---")

        # Recomenda√ß√µes
        st.markdown("### üí° An√°lise")
        for rec in saude_geral['recomendacoes']:
            st.write(f"‚Ä¢ {rec}")

        st.markdown("---")

        # Distribui√ß√£o de detec√ß√µes
        cats = saude_geral.get('gatos_detectados', 0)
        dogs = saude_geral.get('cachorros_detectados', 0)

        if cats > 0 or dogs > 0:
            deteccoes_data = {
                "Gatos üê±": cats,
                "Cachorros üê∂": dogs
            }

            fig_deteccoes = px.pie(
                values=list(deteccoes_data.values()),
                names=list(deteccoes_data.keys()),
                title="Distribui√ß√£o de Detec√ß√µes por Classe",
                color_discrete_sequence=["#FF6B6B", "#4ECDC4"]
            )
            st.plotly_chart(fig_deteccoes, use_container_width=True)

    else:
        st.info("üì≠ Nenhuma an√°lise realizada ainda. Use a aba 'An√°lise de Imagem' para come√ßar.")

# TAB 4: ESTAT√çSTICAS
with tab4:
    st.markdown("## üìà Estat√≠sticas Detalhadas")

    detector = st.session_state.dados_yolo["detector"]
    stats = detector.obter_estatisticas()

    if stats['total_analises'] > 0:
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.metric(
                "Total de An√°lises",
                stats['total_analises']
            )

        with col2:
            st.metric(
                "M√©dia de Objetos",
                f"{stats['media_objetos_por_imagem']:.1f}"
            )

        with col3:
            st.metric(
                "Confian√ßa M√©dia",
                f"{stats['confianca_media_geral']:.1%}"
            )

        with col4:
            st.metric(
                "Classes Detectadas",
                len(detector.classes)
            )

        st.markdown("---")

        # Classes mais detectadas
        st.markdown("### üèÜ Classes Mais Detectadas")

        historico = detector.obter_historico()
        classes_count = {}
        for h in historico:
            for det in h['deteccoes']:
                classe = det['classe']
                classes_count[classe] = classes_count.get(classe, 0) + 1

        if classes_count:
            df_classes = pd.DataFrame([
                {"Classe": k, "Detec√ß√µes": v}
                for k, v in sorted(classes_count.items(), key=lambda x: x[1], reverse=True)
            ])

            col1, col2 = st.columns([1, 1])

            with col1:
                st.dataframe(df_classes, use_container_width=True, hide_index=True)

            with col2:
                fig_classes = px.pie(
                    df_classes,
                    values="Detec√ß√µes",
                    names="Classe",
                    title="Distribui√ß√£o por Classe"
                )
                st.plotly_chart(fig_classes, use_container_width=True)

        st.markdown("---")

        # Relat√≥rio completo
        st.markdown("### üìÑ Relat√≥rio Completo")

        relatorio = st.session_state.dados_yolo["relatorio"].gerar_relatorio_completo()

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("**Dados do Relat√≥rio:**")
            st.write(f"- Data: {relatorio['data_geracao']}")
            st.write(f"- Total de An√°lises: {relatorio['total_analises']}")
            st.write(f"- Sa√∫de Geral: {relatorio['saude_plantacao']}")
            st.write(f"- Score: {relatorio['score_saude']:.1f}/100")

        with col2:
            st.markdown("**Problemas Identificados:**")
            st.write(f"- Pragas: {relatorio['pragas_totais']}")
            st.write(f"- Doen√ßas: {relatorio['doencas_totais']}")
            st.write(f"- Ervas Daninhas: {relatorio['ervas_totais']}")

    else:
        st.info("üì≠ Nenhuma an√°lise realizada ainda. Use a aba 'An√°lise de Imagem' para come√ßar.")

st.markdown("---")

# Rodap√©
st.markdown("""
<div style="text-align: center; color: #666; font-size: 0.9rem;">
    <p><strong>Fase 6</strong> - Vision Computacional com YOLO</p>
    <p>üê± Detec√ß√£o de Gatos e Cachorros em Tempo Real üê∂</p>
    <p>Modelo YOLOv8 Treinado (100 √©pocas (labels corrigidas)) | Dataset: 82 imagens</p>
    <p>FarmTech Solutions | FIAP 2025</p>
</div>
""", unsafe_allow_html=True)
